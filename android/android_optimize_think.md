# Android性能指标

## 目标

    APM 全称 Application Performance Management & Monitoring (应用性能管理/监控)

## 指导思想

如果性能问题，如果也能最大限度的按照“测试发现->问题定位 ->开发修改”的正常流程来走，对产品质量是有非常大贡献的。下文的介绍，目标就在于此：测试过程中，测试工程师识别更多的产品关键场景，通过场景化、工程化、自动化的测试手段，发现更多的性能问题，使得性能BUG收敛于产品发布前。

## Android 性能指标

一个 App 的定位，由产品经理和老板负责；一个 App 的用户体验由 UI/UE 负责；一个 App 的性能和稳定由开发者负责。三者都是一个 App 是否能够成功的重要因素。检验一个 Androd App 的性能的好坏有很多的指标，这些指标将是一个优秀的 Android App 追求的目标，也是一个 Android 功能师追求的目标。这里尽可能的罗列与一款 Android App 性能相关的指标。排名不分先后，相互之间可能有重叠。

1. APK 文件大小
APK 文件大小直接影响到用户下载文件的时间和流量，对安装速度也会有影响。虽然有很多用户并不关心，也不懂，但是作为开发者，咱们可以通过与其他 App 横向对比，一般来说，一个单一的工具类应用的体积不应该比一个平台类的 App 大。比如一个天气预报应用，如果它比微信、QQ还大，那么咱们觉得它肯定有问题。

一般来说，安装文件大的应用，安装后占用的空间也会大，所有从这个角度来说，减少 APK 文件的体积也是必要的，或者把 APK 文件体积纳入到性能指标也是有一定意义的。

当然，相对与其他指标，APK 文件体积并不是那么的重要，到底需不需去考量，需要跟自身当前的情况具体分析了。

2. 安装速度
在一些第三方测评平台，可以给出 APK 的安装速度，影响安装速度的因素有很多，上面所说的安装文件体积是一方面，手机和系统本身也会影响安装速度。另外一个指标是安装失败率，这样的数据一般只有通过第三方测评公司给出。

3. 启动时间、滑动速度、界面切换速度等APP流畅度
启动时间对于一个 App 也是很重要的。影响启动时间的因素不少，在启动的时候，加载的内容多少，加载的资源大小，都影响到了启动时间。优化的时候可以考虑从减少启动加载的内容和延迟加载入手。

4. CPU 占用
一般指在一个时间端内，CPU 的占用值，由最高值，最低值和平均值。这三个简单的数值并不能很好的考量一个 App 的性能，只能从一定程度上反映了 App 的运行是否出现问题。

5. 内存占用
内存的占用并不一定是越少越好。Android 系统为每个应用设定了一个内存的上限，当你超过这个上限的时候，就会出现 OOM。当应用在前台运行的时候，在尽量避免 OOM 的情况下，要合理利用好内存，毕竟以空间换时间还是很划算的。在应用退出或在后台运行的时候，就要尽量释放内存，做一个好孩子，可以尽量避免被系统 kill 掉的风险。

6. GPU 占用
当 GPU 的使用量过高的情况下，优先要考虑一下是否有过度绘制。个人认为，过度绘制是高 GPU 使用的一个主要因素。过度绘制可以通过开发者选项打开查看，非常建议开发者在做 UI 的时候打开这个选项，这样可以很清楚的知道布局是否合理。

7. 网络流量使用
在目前国内的环境下，移动数据流量还是比较贵的，监控以下用户的流量还是有一定必要的，特别是移动数据的流量。

8. 耗电量
安卓系统的设置里，可以查看到每个应用的耗电量。目前不清楚这个电量的计算是否足够科学严谨，但至少从一定程度上可以反映出你的应用运行的频率。

9. 电池温度
在一些第三方测评平台和第三方统计平台上，可以看到他们提供了一个电池温度的数据。目前猜测可能是不能准确获取耗电量，但是电池温度可以作为一个参考依据。

10. FPS
渲染的帧速，正常情况下，一秒钟需要渲染 60 帧，也就是每帧大概需要在 16ms 内渲染完成，如果某一帧的渲染超过了 16ms，就会导致丢帧，从视觉上就出现了卡顿的现象，或者看上去没有那么的丝滑了。

11. 硬盘占用/DISK占用
大部分 App 在运行的过程中，或多或少需要在用户的磁盘上存储一些数据、缓存。如果只关心存，没有关心怎么管理的话，直接的影响是用户的磁盘空间被无情的占用和浪费了。一直以来，很多开发者都是这么干的。所以，有了一些第三方的清理应用，他们会帮助用户清理掉这些文件的。如果你没有足够的实力买通这些第三方清理工具，让他们把你的目录放入他们的白名单里，那么你就会发现你存放的文件莫名的没了。

当然，用户也可能自己手动删除这些文件、目录的，甚至因为你的文件异常的大，超出了用户心里接受范围，用户可能会思考一下，这个应用是否有存在的必要，你的应用可能不保。

12. 崩溃率
很多第三方的统计工具都可以帮助收集崩溃数据并且上报，这些数据非常重要。开发者需要认真对待，并且及时处理这些问题。

## 预期标准指定原则

1. 分析竞争对手的产品，所有指标要强于竞品

2. 产品经理给出的预期性能指标数据

3. 符合业内行业标准

不可置否，在对APP的整个测试环节中，性能测试是一个很重要的环节，它直接影响了用户的体验，那么，对于APP的性能测试，我们到底需要关注那些点呢？

其实，我们可以想想在软件设计、部署、使用、维护中一共有哪些角色参与，然后再考虑这些角色各自关注的性能点是什么，那么作为一个软件性能测试工程师，我们就能够从中总结出，对于APP的性能测试主要应该关注哪些比较重要的点。

一.从用户角度出发

开发软件的目的是为了让用户使用，我们先站在用户的角度分析一下，用户需要关注哪些性能。

对于用户来说，当点击一个按钮、链接或发出一条指令开始，到系统把结果已用户感知的形式展现出来为止，这个过程所消耗的时间是用户对这个软件性能的直观印象。也就是我们所说的响应时间，当响应时间较小时，用户体验是很好的，当然用户体验的响应时间包括个人主观因素和客观响应时间，在设计软件时，我们就需要考虑到如何更好地结合这两部分达到用户最佳的体验。如：用户在大数据量查询时，我们可以将先提取出来的数据展示给用户，在用户看的过程中继续进行数据检索，这时用户并不知道我们后台在做什么。

简单地说，用户最关注的其实就是其操作的响应时间。

二.站在管理员的角度考虑需要关注的性能点

(1)、 响应时间

(2)、 服务器资源使况是否合理

(3)、 应用服务器和数据库资源使用是否合理

(4)、 系统能否实现扩展

(5)、 系统最多支持多少用户访问、系统最大业务处理量是多少

(6)、 系统性能可能存在的瓶颈在哪里

(7)、 更换那些设备可以提高性能

(8)、 系统能否支持7×24小时的业务访问

三.站在开发（设计）人员角度去考虑

(1)、 架构设计是否合理

(2)、 数据库设计是否合理

(3)、 代码是否存在性能方面的问题

(4)、 系统中是否有不合理的内存使用方式

(5)、 系统中是否存在不合理的线程同步方式

(6)、 系统中是否存在不合理的资源竞争

四.站在测试工程师角度考虑

那么从用户、管理员、开发者的角度去总结了其关注的性能指标之后，笔者最终认为，对于测试工程师来说，他们在做性能测试的时候，主要应该关注的测试指标应该是：

(1)连接超时

这个是App关闭的首要问题，而在移动应用中网络错误数据比例报错中最高的就是连接超时错误。想象一下当花重金好不容易把你的App推广到用户手机上，而在用户初次尝试时发生连接超时无法正常使用，多数用户会选择再也不会打开应用第二次。

(2)崩溃

这个已无需多言。APP的崩溃，就是用户的崩溃。当用户使用你的App出现闪退或崩溃时，他们很有可能跑去App Store赠送你一个“一星”差评。

(3)系统交互（电话短信干扰，低电量提醒，push提醒，usb数据线插拔提醒，充电提醒等）

在APP使用过程中，可能会遇到各种中断场景，那么一旦发生这些场景，APP就卡死或者闪退，想必也没有多少用户愿意持续使用你的APP。

(4)弱网下的运行情况

电梯里、地铁上，网络信号差时，APP页面的菊花转不停，界面卡死，同时错误提示一堆，这样的情况怎能不让用户抓狂。

(5) CPU使用问题

CPU频率设置过高时会导致过热,过热导致耗电更严重,CPU频率设置过低导致手机滞后,应用处理缓慢同样会导致耗电。更多时候，用户解决CPU超载问题只能关闭甚至卸载App，App就被Kill了!

性能测试过程中，出现的一些问题可直接导致了用户对当前app的使用率和卸载率，如果app使用时卡顿严重或者加载页面慢，cpu占用率高，导致app闪退等问题，在测试过程中，则需特别关注性能方面的体验，app性能好、ui设计美观、功能层级明确，路径层级较少，均可提升用户对app的使用率，性能测试中可关注的问题如下：

　　1、连接超时：app关注的首要问题，在移动应用中网络错误数据比例报错中最高的就是连接错误超时

　　2、闪退：点击某一个功能点出现闪退，客户的内心都崩溃了

　　3、卡顿、黑白屏：

　　4、崩溃：（优秀：0～2%%，标准：2～4%%，轻微隐患：4～12%%，严重隐患：12%%以上）常表现为出现crash

　　5、网络劫持

　　6、交互性能差：（优秀：0～300ms,标准：300ms～400ms，轻微隐患：400ms～1000ms，严重隐患：1000ms以上）电话短信干扰、低电量提

　　　  醒、push提醒、usb数据线插拔提醒、充电提醒

　　7、cpu使用率：建议值>90%，cpu频率设置过高时会导致过热,导致耗电更严重，cpu频率设置过低导致手机滞后，应用处理缓慢同样导致耗电，则优

　　     就好，避免被卸掉

　　8、内存泄漏：指的是你用malloc或new申请了一块内存，但是没有通过free或delete将内存释放，导致这块内存一直处于占用状态

　　9、不良接口：多余的接口存在但是一直没有用到

　　10、响应时间：（优秀：0～400ms，标准：400ms～2000ms，轻微隐患：2000ms～5000ms，严重隐患：5000ms以上),应用发出一个HTTP请

　　　　求到主机，主机端返回响应所用的时间，可分为强网和弱网，强网不做介绍，弱网下，如电梯里、地铁上网络信号差时，app页面一直转圈加载

　　      界面卡死，同时错误提示，用户体验特差。

　　11、流量占用情况：每秒钟平均流量，建议值<5.12kb，每10分钟平均流量，建议值<3MB,存在app偷跑流量等行为，当用户看app占用流量时，如你

　　　　的app占据第一位，流量跑的离谱，则存在果断卸载的可能

　　12、耗电量：根手机调整的亮度和长时间使用app均有关系，如打游戏，则耗电量高于普通app的耗电量使用

　　13、FPS：FPS大于18帧比率，建议值大于90%

总结为：

　　1）及时性：启动时间／操作响应时间／内容加载时间

　　2）稳定性：启动／操作／内容加载成功率

　　3）资源消耗：cpu／内存／流量

　　4）功耗：不同网络下运行时／待机耗电量

 

APP性能测试好的指标：

　　应用启动快速快、UI反馈响应及时、列表滚动操作流畅、内存使用合理、无crash等

目标与战法
尝试概括下性能测试：通过自动化的测试工具模拟多种正常、峰值以及异常负载条件来对系统的各项性能指标进行测试。成功的性能测试，会具备以下几个特点：

提供给开发的信息具有精准性（必备）；
测试方法高效，测试数据稳定可靠（必备）；
使用的分析方法具有高可信度（必备）；
测试熟练使用工具帮助开发定位性能问题（可选）。
提供给开发的信息具有精准性。如果测试或用户告诉开发同学：“你们这个版本性能很差！”、“用着用着手机就开始发烫了，你搞定一下！”开发同学内心肯定是迷茫的。

如果测试将自己的措辞换成：“资讯页面，观看视频过程耗电量高，这个版本比上个版本jiffs高了30%。”，这样开发团队可以根据模块指定跟进人，知道具体的路径，知道耗电量的优化目标（这个版本多出的这30%），那问题的推进必然会更加顺利。

测试方法高效，测试数据稳定可靠。在设计本框架前，团队执行性能测试，包括长板性能测试（亮屏后台耗电及内存）、手工驱动的场景性能测试、基于页面驱动的流畅度测试。

1、 长板性能，场景过于单一，基本只校验了管家后台进程无任何操作下的性能表现；

2、 相比于UI自动化驱动，手工测试无法保证收集到大样本数据（让人反复做一个操作30分钟，这种任务毫无疑问是对员工的摧残）；

3、 页面驱动的流畅度测试，经常出现两次对同一版本的测试得出截然不同的测试结果，测试数据不稳定，难以向开发证明其代码有问题。后文介绍流畅度测试时再详述优劣。

使用的分析方法具有高可信度。传统的分析方案中，往往简单地采用均值来评估性能项。笔者认为，合理的选用评估算法，也能让你的测试报告更有说服力。一个存在少量毛刺的数据序列，如下图，由于毛刺偏离严重，将严重拉低平均值。多一个毛刺，少一个毛刺，均值都会有很大不一样，在样本量较少时，往往会出现两次测试获得的性能数据差异大的问题。（如何解决后面详述）。


图一 流畅度样本

测试熟练使用工具帮助开发定位性能问题。测试左移一点，多做一点，开发就可以少花一点精力在缩小问题访问上。在功能测试中，一个BUG从偶然复现到找到必现路径，会让开发减少大量定位问题时间。同样，在性能测试中，如果测试能指明哪个线程是功率消耗大户，哪个对象是内存泄漏祸首，那么开发也能更加迅速地修复问题。同时，测试在定位过程中，不仅仅提升了自身能力，也建立起了自己的技术形象。

性能测试框架设计
如下图，本次设计的性能测试框架，包含有数据收集、数据分析、UI自动化、驱动框架四个模块，各自独立解耦。这样设计能够降低用例接入成本，可扩展性好。






图二 框架设计原理图

数据收集方案
我们需要通过一种或多种数据，直接反应一项性能的好坏。所以如何收集数据样本？收集那些数据样本，是性能测试框架必备的一个模块。

UI驱动方案
移动客户端的性能测试，主要是模拟用户操作来创造类用户使用场景，获取使用过程中的CPU、mem、流畅度等数据，以衡量该使用场景下，被测应用的性能指标。

本框架的UI自动化框架，选择了python 版的uiautomator（GitHub开源代码）。主要有如下几点原因：

数据收集模块需要使用adb工具，做adb输出结果处理、文本分析，python在这方面有较大优势，代码量低；
Xiaocong封装的开源python版uiautomator，非常轻量级，功能全面，直接使用开源项目，能够节省非常多的框架开发时间；
驱动框架介绍
在本框架中，测试人员能够用如下的命令行直接驱动一个或多个用例的执行，所以设计了类testng逻辑的方案。

Python startTest.py -t 3 -c SwitchTabTest
Python startTest.py -t 3 -m SwitchTabTest,swipeDownTest
如下图，CaseExecutor类用来驱动和组织各个用例的suite_up()，set_up()，test()，tear_donw()，suite_down()等方法。






图三 类junit的驱动部分

而用例中包含的这些方法，主要作用是：

a) suite_up() : 用于执行初始化环境

b) set_up() : 主要用于拉起相应的性能数据收集线程、使用UI自动化初始化应用到被测场景，如闪屏滑动，进入主页等。

c) test() : UI自动化执行场景的关键逻辑，如：测试“连续播放不同视频”场景的内存泄漏。则用例需要在test()方法中，使用uiautomator实现循环点击不同视频播放的逻辑。

d) tear_down() : 该方法主要用于通知数据收集线程停止数据收集，进行数据归档；

e) suite_down() : 该方法将清空环境，将所有数据汇总到报告中，并使用数据分析算法得到可以直接用于报告的内容。






图四 执行逻辑

如图四，UI自动化在test()中执行相应场景时，性能数据收集线程会持续收集性能数据

注明：上述的五个步骤并不需要在每个case中实现，对应同一专项，除了test()，其他四个方法，都具有相同的逻辑，抽象到父类中实现即可，这样可以做到同一个专项下的不同场景用例，只需要写一个test方法。

数据分析方案
拿到数据后，想要最大化数据的价值。合理合适的数据分析方案显得尤为重要。笔者一开始做性能测试，所能想到的也就是拿到一大堆样本数据，取平均值，再做对比分析。

本框架试图提供除了平均值外，提供其他更为丰富的数据来评估各类性能指标。包括：

a) 中位数：以它在所有标志值中所处的位置确定的全体单位标志值的代表值，不受分布数列的极大或极小值影响，从而在一定程度上提高了中位数对分布数列的代表性。中位数用于评估网络延迟样本，效果明显优于平均值。原因在于，如大部分延迟在20ms时，其中有几个异常样本值2000ms以上，它们会严重拉高均值，导致均值不能完全代表该延迟数据序列。

b) 方差与标准差：结合均值来评估数据序列，可以评估到数据序列的离散程度。

c) 分布图或分布表：分布图或分布表也能比较好的评估一个数据序列的好坏，用它来做流畅度、网络带宽、网络延迟等性能评估，能够比较直观、详细地给出对比结果。






图五 流畅度优化效果示意

d) 曲线图：内存性能的评估，最优解莫过于占用曲线+ 平均值了。






图六 占用内存曲线

f) 平均值：最传统的均值，依然是一柄利器。

g) 极大值、极小值。

https://zhuanlan.zhihu.com/p/30095972



## 遵循原则

* 持续测量

    用户体感从来不是一个好主意，通过量化数据持续测量。搭建可持续监控的体系。通过数据监控优化前后的效果

* 使用低端设备

    低端设备更能暴露问题

* 衡量投入产出比

    优化是一个持续的过程，很多时候需要在时间跟空间上做取舍。

## 工具

* Systrace 

* Traceview 是一个性能分析工具，告诉我们每一个方法执行了多长时间

* 层级观察器

* 开启StrictMode

## 监控体系参考

[蜂鸟团队移动端异常监控体系建设](https://juejin.im/post/5b874cbce51d4538b77667e3?utm_source=gold_browser_extension)

[Android 性能监控系列一（原理篇）](https://segmentfault.com/a/1190000015183096)
