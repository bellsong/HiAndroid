#Android 端内反作弊技术总结

#### 背景
在Android 应用商店、广告SDK、商业化流量这些业务场景对传统的下载流量质量要求很高。其中高收益下也引发了相关黑产对这些流量进行作弊。刷榜单、刷量提升产品曝光破坏原有健康的竞争环境对产品都带来了很大的影响。针对商业侧甚至影响相关CP花了大价钱却收益极低。
为了解决这一系列问题也衍生出了一系列的反作弊方案，本文简单对反作弊的思路和方向做一些介绍。

#### 多维度反作弊简介
作弊手段可以从核心的两个个维度去思考。
当前用户的环境是不是作弊环境？当前用户行为是不是属于作弊行为？

#### 环境之真机识别
模拟器是黑产很常用的手段、基于反模拟器也衍生出了相对应的方案。常见的模拟器已经有相关的鉴别方式。这里就不展开，入手方式可以参考QEMU、BlueStack、Genmotion等特征鉴别。

#### 传感器鉴别法
传感器鉴别法是对真机识别一种稍重的手段。利用的特性也是模拟器中对传感器模拟逼真程度不够作为区分。 该方法会采集传感器的多个数据，其中包含传感器的数量、对应传感器的数据。针对温度、海拔等传感器判断该传感器是否在正常值范围内。针对陀螺仪、加速度传感器 判断数据是否成随机性分布等规律特点、是否符合自然场景。

#### 前端数据鉴别法
通常开模拟器都有重新创建流程。通过系统API获取当前的一些核心数据也可以作为判别的其中一个手段。采集用户机型、imei、mac、应用安装数量、sim卡 信号 制式、build信息、SD卡大小等全局信息进行校验检测（数据真实性、数据匹配度、数据前后一致性）。通常模拟器或多或少会疏漏某些数据从这些数据维度加权综合识别。其中需要注意的对相关数据要做好排除误伤（部分国产厂商应用安装数量就是给的比较少，加了权限控制）。

#### 文件检测法
文件检测稍重。部分模拟器会预装应用。扫描目录、扫描安装列表。对环境内含有bluestack apk 或者其他相关敏感模拟器文件则可识别为模拟器。

#### cpu架构鉴别法
大多数模拟器走的是X86 架构，其中衍生出的一种方式就是对CPU架构进行识别。其中可以利用底层cache 特性进行识别区分。这个方案最早是15 年某老外在bluestack 发表、核心的点是利用哈佛架构和冯诺依曼架构的区别来区分ARM和X86。哈佛架构中程序指令储存和数据储存是分开的而冯诺依曼则合并在一起。指令和数据分开存储的结构中，这两个cache不是同步的，因此一个特定地址的数据值在一个cache中更新了，但是在另一个cache就没有更新。针对这种特性 arm架构中重复对某地址写入指令则会导致指令不执行，而模拟器则会执行。详细的参考文档可以参照 1.乌云备份链接 2.ATA 文章 这两篇文章。（bluestack 原文已删）

#### 双开Hook鉴别法
双开技术很多都是基于文件隔离可以依靠文件路径进行判别。也可以在native层使用当前环境pid 与特定双开产品包名进行匹配校验。相关技术可以参考 AntiVM检测实现。
Xposed 框架检测。通过PM 检测Xposed 特定包是否安装来判别。
Hook检测。Hook在java层大多需要二次invoke，因此可以通过捕捉调用堆栈，分析堆栈判断是否进行了二次调用来做甄别。

#### 行为检测
行为检测十分依赖数据能力，对数据分析思维要求高，但也是整体上最有效细致的手段，但实效性却是它的最大壁垒。用户在真实环境下的行为始终千变万化，但作弊用户始终有他的作弊特点，结合数据长时间分析很容易找到作弊用户的特征。探索作弊用户特征之路、也是防御之路的核心。各个业务场景下作弊行为模型差异会很大，下面会列举些常见的思路作为参考。

#### 作弊用户识别模型
数据完整性侦测

真实用户在数据链路上都是比较完整，作弊用户会出现断层。如刷量的用户可能只刷接口UA不同于真机，刷模拟器的用户可能部分页面永远访问不到，部分接口的请求量会偏低等等。采集数据时可以从完整性上进行筛选判别。

#### 可变数据侦测

当端采集一些核心数据后就可以初步分析数据建立自己的识别模型。如：基于用户地理位置合理性进行判别。pokemon go中对飞机的作弊封锁就是思路之一。举一反三，部分高日活用户，经纬度从来不变就值得加入风险用户。类似的数据源还有很多，手机的信号量、温度等从来不变。下载量等核心数据聚拢在部分IP段等等。

固有数据找规律。

一些脚本很有特点，很喜欢把数字累加、字母累加。部分作弊用户可能脚本会更复杂，但是数据侧还是会有规律可寻。寻找这些数据中的蛛丝马迹完善自己的模型，增强防护能力。产品侧也可以看留存率，终端用户操作系统的占比，IP分布等。

#### 用户自然行为分析

针对业务比如在应用市场中存在大量刷量用户。只下载，不安装；只安装，不注册；次留低等特点。部分群体只访问特定页面，有自己的特征和全量用户的行为模型格格不入。针对用户的自然行为前期建立好完整的链路搭建好行为模型（页面访问路径，点击链路，转换链路等）也很容易排查。

#### 触控行为检测

触控是端的一个核心行为。真实用户的点击行为中有几个特点，点击区域不固定，点击中会抖动，点击时长不固定，点击后访问新页面进行下一步操作会有不定期间隔。 其中facebook sdk中就会对点击事件的整个touch点进行tracker，检测当前用户的点击行为是否真实。以上几个特点到数据中的表现就会对应，点击的xy 差异大，点击中的xy有不规则的偏移，down 到up 耗时不固定，下一次点击时间间隔会通常比脚本长且不固定。

### 总结

攻和防始终是门比较高深的艺术。笔者也只是抛砖引玉，希望给小白带来一些启发。新时代的反作弊始终要多端配合。作弊也需要成本始终会有疏漏的环节，善于找到这些用户，建立完备的监控体系，做好全时刻、全链路的反作弊相信我们的系统也会越来越健壮。